import{compile as G,env as u,normalizePath as x}from"@tailwindcss/node";import{clearRequireCache as U}from"@tailwindcss/node/require-cache";import{Scanner as R}from"@tailwindcss/oxide";import{Features as y,transform as F}from"lightningcss";import m from"path";var M=/[?&](raw|url)\b/;function V(){let a=[],r=null,o=!1,c=!1,g=[],h=new Set,d=new R({}),l=new S(t=>new w(t,()=>h,r.base));function b(t,e,i,s){let n=!1;for(let f of d.scanFiles([{content:e,extension:i}]))n=!0,h.add(f);n&&P(s)}function P(t){for(let e of a){let i=[];for(let s of l.keys()){let n=e.moduleGraph.getModuleById(s);if(!n){t||l.delete(s);continue}l.get(s).requiresRebuild=!1,e.moduleGraph.invalidateModule(n),i.push({type:`${n.type}-update`,path:n.url,acceptedPath:n.url,timestamp:Date.now()})}i.length>0&&e.hot.send({type:"update",updates:i})}}async function B(t,e){let i=t.lastContent,s=await t.generate(i,e);if(s===!1)return;u.DEBUG&&console.time("[@tailwindcss/vite] Optimize CSS");let n=q(s,{minify:c});return u.DEBUG&&console.timeEnd("[@tailwindcss/vite] Optimize CSS"),n}async function D(t,e,i){let s={...t,getCombinedSourcemap:()=>{throw new Error("getCombinedSourcemap not implemented")}};for(let n of g){if(!n.transform)continue;let f="handler"in n.transform?n.transform.handler:n.transform;try{let p=await f.call(s,i,e);if(!p)continue;typeof p=="string"?i=p:p.code&&(i=p.code)}catch{console.error(`Error running ${n.name} on Tailwind CSS output. Skipping.`)}}return i}return[{name:"@tailwindcss/vite:scan",enforce:"pre",configureServer(t){a.push(t)},async configResolved(t){r=t,c=r.build.cssMinify!==!1,o=r.build.ssr!==!1&&r.build.ssr!==void 0;let e=["vite:css",...r.command==="build"?["vite:css-post"]:[]];g=r.plugins.filter(i=>e.includes(i.name))},transformIndexHtml(t,{path:e}){b(e,t,"html",o)},transform(t,e,i){let s=E(e);v(e)||b(e,t,s,i?.ssr??!1)}},{name:"@tailwindcss/vite:generate:serve",apply:"serve",enforce:"pre",async transform(t,e,i){if(!v(e))return;let s=l.get(e);i?.ssr||await Promise.all(a.map(f=>f.waitForRequestsIdle(e)));let n=await s.generate(t,f=>this.addWatchFile(f));return n?{code:n}:(l.delete(e),t)}},{name:"@tailwindcss/vite:generate:build",apply:"build",enforce:"pre",async transform(t,e){if(!v(e))return;let s=await l.get(e).generate(t,n=>this.addWatchFile(n));return s?{code:s}:(l.delete(e),t)},async renderStart(){for(let[t,e]of l.entries()){let i=await B(e,()=>{});if(!i){l.delete(t);continue}await D(this,t,i)}}}]}function E(a){let[r]=a.split("?",2);return m.extname(r).slice(1)}function v(a){let r=E(a);return(r==="css"||r==="vue"&&a.includes("&lang.css")||r==="astro"&&a.includes("&lang.css"))&&!M.test(a)}function q(a,{file:r="input.css",minify:o=!1}={}){return F({filename:r,code:Buffer.from(a),minify:o,sourceMap:!1,drafts:{customMedia:!0},nonStandard:{deepSelectorCombinator:!0},include:y.Nesting,exclude:y.LogicalProperties,targets:{safari:16<<16|1024},errorRecovery:!0}).code.toString()}function C(a){return m.resolve(a.replace(/\?.*$/,""))}var S=class extends Map{constructor(o){super();this.factory=o}get(o){let c=super.get(o);return c===void 0&&(c=this.factory(o,this),this.set(o,c)),c}},w=class{constructor(r,o,c){this.id=r;this.getSharedCandidates=o;this.base=c}lastContent="";compiler;requiresRebuild=!0;scanner;candidates=new Set;dependencies=new Set;async generate(r,o){this.lastContent=r;let c=C(this.id),g=m.dirname(m.resolve(c));(!this.compiler||!this.scanner||this.requiresRebuild)&&(U(Array.from(this.dependencies)),this.dependencies=new Set([C(c)]),u.DEBUG&&console.time("[@tailwindcss/vite] Setup compiler"),this.compiler=await G(r,{base:g,onDependency:d=>{o(d),this.dependencies.add(d)}}),u.DEBUG&&console.timeEnd("[@tailwindcss/vite] Setup compiler"),this.scanner=new R({sources:this.compiler.globs})),u.DEBUG&&console.time("[@tailwindcss/vite] Scan for candidates");for(let d of this.scanner.scan())this.candidates.add(d);u.DEBUG&&console.timeEnd("[@tailwindcss/vite] Scan for candidates");for(let d of this.scanner.files)o(d);for(let d of this.scanner.globs){if(d.pattern[0]==="!")continue;let l=m.relative(this.base,d.base);l[0]!=="."&&(l="./"+l),l=x(l),o(m.posix.join(l,d.pattern))}this.requiresRebuild=!0,u.DEBUG&&console.time("[@tailwindcss/vite] Build CSS");let h=this.compiler.build([...this.getSharedCandidates(),...this.candidates]);return u.DEBUG&&console.timeEnd("[@tailwindcss/vite] Build CSS"),h}};export{V as default};
